<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="prism.css" />
    <title>Document</title>
  </head>
  <body>
    <main>
      <div class="box">
        <div class="box__title">Buffers</div>
        <pre class="box__content">
<code class="language-javascript" data-buffers></code>
          </pre>
      </div>
      <!-- box -->

      <div class="box">
        <div class="box__title">Attributes</div>
        <pre class="box__content">
<code class="language-javascript" data-attributes></code>
          </pre>
      </div>
      <!-- box -->

      <div class="box">
        <div class="box__title">Uniforms</div>
        <pre class="box__content">
<code class="language-javascript" data-uniforms></code>
          </pre>
      </div>
      <!-- box -->

      <div class="box">
        <div class="box__title">Vertex shader</div>
        <pre class="box__content">
<code class="language-glsl" data-vertex></code>
            </pre>
      </div>

      <div class="box">
        <div class="box__title">Fragment shader</div>
        <pre class="box__content">
<code class="language-glsl" data-fragment></code>
            </pre>
      </div>

      <div class="canvas">
        <canvas class="canvas__frame"></canvas>
        <div class="canvas__layer-x">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>

        <div class="canvas__layer-y">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </main>

    <script src="./prism.js"></script>
    <script src="./n/1.js"></script>
    <script>
      // update view
      document.querySelector("[data-buffers]").innerHTML = BUFFERS;
      document.querySelector("[data-attributes]").innerHTML = ATTRIBUTES;
      document.querySelector("[data-uniforms]").innerHTML = UNIFORMS;

      // document.querySelector("[data-fragment]").innerHTML = FRAGMENT;
      document.querySelector("[data-vertex]").innerHTML = VERTEX;
      document.querySelector("[data-fragment]").innerHTML = FRAGMENT;

      // start real deal
      const $canvas = document.querySelector(".canvas__frame");
      const gl = $canvas.getContext("webgl");

      const WIDTH = $canvas.getBoundingClientRect().width;
      const HEIGHT = $canvas.getBoundingClientRect().height;

      const _ATTRIBUTES = JSON.parse(ATTRIBUTES);
      const _BUFFERS = JSON.parse(BUFFERS);
      const _UNIFORMS = JSON.parse(UNIFORMS);

      $canvas.width = WIDTH;
      $canvas.height = HEIGHT;

      gl.viewport(0, 0, WIDTH, HEIGHT);

      function compileShader(gl, shaderSource, shaderType) {
        var shader = gl.createShader(shaderType);
        gl.shaderSource(shader, shaderSource);
        gl.compileShader(shader);

        var success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);

        if (!success) {
          throw "could not compile shader:" + gl.getShaderInfoLog(shader);
        }

        return shader;
      }

      const vs = compileShader(gl, VERTEX, gl.VERTEX_SHADER);
      const fs = compileShader(gl, FRAGMENT, gl.FRAGMENT_SHADER);
      const program = gl.createProgram();
      gl.attachShader(program, vs);
      gl.attachShader(program, fs);
      gl.linkProgram(program);
      gl.useProgram(program);

      for (const attribName in _ATTRIBUTES) {
        const fattrib = _ATTRIBUTES[attribName];
        const fbuffer = _BUFFERS[fattrib.buffer];

        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array(fbuffer),
          gl.STATIC_DRAW
        );

        const location = gl.getAttribLocation(program, attribName);
        gl.enableVertexAttribArray(location);
        gl.vertexAttribPointer(location, fattrib.size, gl.FLOAT, false, 0, 0);
      }

      gl.clearColor(1, 1, 1, 0);
      gl.clear(gl.COLOR_BUFFER_BIT);
      gl.drawArrays(gl.TRIANGLES, 0, 3);
    </script>
  </body>
</html>
